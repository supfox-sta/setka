{extends "../@layout.xml"}
{block title}{_my_messages}{/block}
{block titleHeader}{_my_messages}{/block}

{block body}
  <div style="padding:10px;display:flex;flex-direction:column;gap:10px;">
    <!-- Tabs: All | Groups -->
    {var $tab = (isset($_GET['tab']) ? (string)$_GET['tab'] : '')}
    {var $groupsOnly = ($tab === 'groups')}
    <div class="coolTabs" style="display:flex;gap:8px;">
      <a n:attr="id => !$groupsOnly ? 'act_tab_a' : ''" href="/im" class="button" style="padding:8px 12px;border-radius:10px;">{_all_messages}</a>
      <a n:attr="id => $groupsOnly ? 'act_tab_a' : ''" href="/im?tab=groups" class="button" style="padding:8px 12px;border-radius:10px;">{_groups}</a>
    </div>

    <!-- Search -->
    <form action="/im/search" method="POST" style="margin:0;">
      <input type="text" name="pattern" placeholder="{_search_messages}" required class="text long-field" />
    </form>

    <!-- Groups list -->
    {if $groupsOnly && isset($groups)}
      <div class="scroll_container">
        <div class="scroll_node" n:foreach="$groups as $g" style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.08);" onmousedown="window.location.assign('/grp' + {$g['id']});">
          <img n:if="isset($g['avatar_url']) && $g['avatar_url']" src="{$g['avatar_url']}" alt="Group" width="44" height="44" style="border-radius:50%;object-fit:cover;" />
          <img n:if="!isset($g['avatar_url']) || !$g['avatar_url']" src="/assets/packages/static/openvk/img/dialog_group.png" alt="Group" width="44" height="44" style="border-radius:50%;object-fit:cover;" />
          <div style="flex:1;min-width:0;">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{$g['title'] ?: ('ID ' . $g['id'])}</div>
            <div style="opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{$g['last'] ?? tr('no_messages')}</div>
          </div>
          <div style="opacity:.6;">â€º</div>
        </div>
      </div>
    {elseif sizeof($corresps) > 0}
      <!-- Dialogs list -->
      <div class="scroll_container">
        <div class="scroll_node" n:foreach="$corresps as $coresp" n:if="!$groupsOnly || (count($coresp->getCorrespondents()) >= 2)" style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.08);" onmousedown="window.location.assign({$coresp->getURL()});">
          {var $recipient = $coresp->getCorrespondents()[1]}
          {var $lastMsg   = $coresp->getPreviewMessage()}
          <img src="{$recipient->getAvatarURL('miniscule')}" alt="ava" width="44" height="44" style="border-radius:50%;object-fit:cover;" />
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:6px;">
              <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{$recipient->getCanonicalName()}</div>
              <span style="opacity:.6;font-size:12px;white-space:nowrap;">{$lastMsg->getSendTimeHumanized()}</span>
            </div>
            <div n:class="unread => $lastMsg->getUnreadState()" style="opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{$lastMsg->getText()|noescape}</div>
          </div>
          <div n:if="$lastMsg->getUnreadState()" style="width:10px;height:10px;border-radius:5px;background:#2563eb;"></div>
        </div>
      </div>
    {else}
      <div style="opacity:.75;text-align:center;padding:20px 0;">{_no_messages}</div>
    {/if}

    <div style="height:88px;"></div>
  </div>
{/block}
